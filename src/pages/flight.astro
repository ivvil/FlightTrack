---
export const prerender = false; 
import { getJson } from "serpapi"
import { Icon } from 'astro-icon/components';

import '../styles/global.css';

const url = new URL(Astro.request.url);
const origin = url.searchParams.get("origin") || "MAD";
const destination = url.searchParams.get("destination") || "PRG";
const outbound_date = url.searchParams.get("departure_date") || "2025-02-11";
const return_date = url.searchParams.get("return_date") || "2025-02-17";

const apiParameters = {
  api_key: "473891f9fe1d46bafef7075e2b6a08fa8fe2c38a030ecd5eafff1573c9465921",
  engine: "google_flights",
  hl: "en",
  gl: "us",
  departure_id: origin,
  arrival_id: destination,
  outbound_date,
  return_date,
  currency: "USD"
};

let flightData = await new Promise((resolve, reject) => {
  getJson(apiParameters, (json) => {
    resolve(json);
  });
});

const flights = [
  ...(flightData.best_flights || []),
  ...(flightData.other_flights || [])
];

const ordenarResultado = (orden) => {
  switch (orden) {
    case "mayorPrecio":
      flights.sort((a, b) => b.price - a.price);
      break;
    case "menorPrecio":
      flights.sort((a, b) => a.price - b.price);
      break;
    case "mayorDuracion":
      flights.sort((a, b) => b.total_duration - a.total_duration);
      break;
    case "menorDuracion":
      flights.sort((a, b) => a.total_duration - b.total_duration);
      break;
    case "masEscalas":
      flights.sort((a, b) => b.flights.length - a.flights.length);
      break;
    case "menosEscalas":
      flights.sort((a, b) => a.flights.length - b.flights.length);
      break;
    default:
      break;
  }
};

const criterioOrden = url.searchParams.get("ordenar");
if (criterioOrden) {
  ordenarResultado(criterioOrden);
}

// Filtra solo los vuelos directos sin escalas
const directFlights = flights.filter((flight) => flight.flights.length === 1);
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Resultados de Vuelos</title>
  </head>
  <body class="min-h-screen bg-gray-50 py-10">
    <div class="max-w-7xl mx-auto px-4">
      <a href="/" class="flex items-center text-blue-500 hover:text-blue-700 mb-6">
        <Icon name="mdi:arrow-left" class="h-6 w-6 mr-2" />
        Volver
      </a>

      <!-- Formulario con estilos -->
      <div class="mb-8">
        <form method="GET" action="/flight" class="flex flex-wrap items-center gap-4">
          <input type="hidden" name="origin" value={origin} />
          <input type="hidden" name="destination" value={destination} />
          <input type="hidden" name="departure_date" value={outbound_date} />
          <input type="hidden" name="return_date" value={return_date} />
          <label for="ordenar" class="text-gray-700 font-medium">Ordenar por:</label>
          <select name="ordenar" id="ordenar" onchange="this.form.submit()" class="border border-gray-300 rounded-md p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Selecciona...</option>
            <option value="mayorPrecio" selected={criterioOrden === "mayorPrecio"}>Mayor Precio</option>
            <option value="menorPrecio" selected={criterioOrden === "menorPrecio"}>Menor Precio</option>
            <option value="mayorDuracion" selected={criterioOrden === "mayorDuracion"}>Mayor Duraci칩n</option>
            <option value="menorDuracion" selected={criterioOrden === "menorDuracion"}>Menor Duraci칩n</option>
            <option value="masEscalas" selected={criterioOrden === "masEscalas"}>M치s Escalas</option>
            <option value="menosEscalas" selected={criterioOrden === "menosEscalas"}>Menos Escalas</option>
          </select>
        </form>
      </div>

      <h1 class="text-4xl font-bold text-gray-800 mb-10 text-center">Resultados de Vuelos Directos</h1>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        {directFlights.map((flight) => {
          const segment = flight.flights[0];
          return (
            <div class="bg-white rounded-lg shadow-lg overflow-hidden transform transition duration-300 hover:scale-105 hover:shadow-2xl">
              <img src={flight.airline_logo} alt={segment.airline} class="h-32 w-full object-contain p-4 bg-gray-100" />
              <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-2">
                  {segment.airline} - {segment.flight_number}
                </h2>
                <p class="text-gray-700 text-sm mb-1">
                  <span class="font-medium">Salida:</span> {segment.departure_airport.name} ({segment.departure_airport.id})<br />
                  <span class="text-gray-500">{segment.departure_airport.time}</span>
                </p>
                <p class="text-gray-700 text-sm mb-1">
                  <span class="font-medium">Llegada:</span> {segment.arrival_airport.name} ({segment.arrival_airport.id})<br />
                  <span class="text-gray-500">{segment.arrival_airport.time}</span>
                </p>
                <p class="mt-3 text-lg font-bold text-blue-600">Precio: ${flight.price}</p>
                <p class="mt-1 text-sm text-gray-600">
                  Duraci칩n total: {Math.floor(flight.total_duration / 60)}h {flight.total_duration % 60}m
                </p>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </body>
</html>